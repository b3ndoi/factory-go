name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out ./factory/...

    - name: Get coverage
      id: coverage
      run: |
        coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
        echo "coverage=$coverage" >> $GITHUB_OUTPUT

    - name: Get version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        # Extract changelog for this version from CHANGELOG.md
        if [ -f CHANGELOG.md ]; then
          echo "Found CHANGELOG.md"
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Factory-Go ${{ steps.version.outputs.version }}
        body: |
          ## Factory-Go ${{ steps.version.outputs.version }}
          
          A Laravel-inspired, type-safe factory library for Go.
          
          ### 📊 Stats
          - ✅ Tests: 60 passing
          - ✅ Coverage: ${{ steps.coverage.outputs.coverage }}
          - ✅ Features: 35+ methods
          - ✅ Examples: 6 working examples
          
          ### 📥 Installation
          
          ```bash
          go get github.com/b3ndoi/factory-go@${{ steps.version.outputs.version }}
          ```
          
          ### 📖 Documentation
          
          - [README](https://github.com/b3ndoi/factory-go/blob/main/README.md)
          - [Examples](https://github.com/b3ndoi/factory-go/tree/main/examples)
          - [API Docs](https://pkg.go.dev/github.com/b3ndoi/factory-go@${{ steps.version.outputs.version }})
          - [CHANGELOG](https://github.com/b3ndoi/factory-go/blob/main/CHANGELOG.md)
          
          ### ✨ Features
          
          - 🎯 Type-safe with Go generics
          - 🔧 Complete Laravel factory parity
          - 🔗 Full relationship support (For, Has, HasAttached, Recycle)
          - ⚡ Must* variants for clean test code
          - 📦 RawJSON() for API testing
          - 🐛 Debugging tools (Tap, Clone, When/Unless)
          
          See [CHANGELOG.md](https://github.com/b3ndoi/factory-go/blob/main/CHANGELOG.md) for complete details.
        draft: false
        prerelease: false
        generate_release_notes: true

  notify:
    name: Notify pkg.go.dev
    runs-on: ubuntu-latest
    needs: release
    
    steps:
    - name: Trigger pkg.go.dev update
      run: |
        version="${GITHUB_REF#refs/tags/}"
        curl "https://proxy.golang.org/github.com/b3ndoi/factory-go/@v/${version}.info" || true

